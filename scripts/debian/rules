#!/usr/bin/make -f

DEBIAN_DIR := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

#DEB_TARGET_ARCH=arm64
#DEB_TARGET_ARCH_BITS=64
#DEB_TARGET_ARCH_CPU=arm64
#DEB_TARGET_ARCH_ENDIAN=little
#DEB_TARGET_ARCH_OS=linux
#DEB_TARGET_GNU_CPU=aarch64
#DEB_TARGET_GNU_SYSTEM=linux-gnu
#DEB_TARGET_GNU_TYPE=aarch64-linux-gnu
#DEB_TARGET_MULTIARCH=aarch64-linux-gnu

export P
export E

ifndef OUTPUT_DIR
OUTPUT_DIR := $(DEBIAN_DIR)/../../output
endif

ifeq ($(P)$(E),10)
KERNELDIR := $(AXIOMBSP)/build/linux/kernel/link-to-kernel-build
ROOTFSDIR := $(AXIOMBSP)/build/linux/rootfs/targetroot
else
KERNELDIR := $(OUTPUT_DIR)/build/linux-custom
ROOTFSDIR := $(OUTPUT_DIR)/target
endif

KVERSION := $(shell cat $(KERNELDIR)/include/config/kernel.release)
KVERSION := $(subst -dirty,,$(KVERSION))

.PHONY: build build-arch build-indep binary binary-arch binary-indep clean

build: build-arch build-indep

build-arch:
	dh_testdir

build-indep:

binary: binary-arch binary-indep

binary-arch: make-changelog
	dh_testroot
	dh_prep
	dh_installdirs

	mkdir -p $(DEBIAN_DIR)/tmp/lib/modules/$(KVERSION)
	mkdir -p $(DEBIAN_DIR)/tmp/boot
	cp -r $(ROOTFSDIR)/lib/modules/$(KVERSION)/* \
		$(DEBIAN_DIR)/tmp/lib/modules/$(KVERSION)
	cp $(KERNELDIR)/System.map \
		$(DEBIAN_DIR)/tmp/boot/System.map-$(KVERSION)
	rm -f -r $(DEBIAN_DIR)/tmp/lib/modules/$(KVERSION)/extra
	rm -f $(DEBIAN_DIR)/tmp/lib/modules/$(KVERSION)/build
	rm -f $(DEBIAN_DIR)/tmp/lib/modules/$(KVERSION)/source

	dh_install --list-missing
	dh_installdocs
	dh_installchangelogs
	dh_installexamples
	dh_installman
	dh_installcatalogs
	dh_installcron
	dh_installdebconf
	dh_installemacsen
	dh_installifupdown
	dh_installinfo
	dh_installinit
	dh_installmenu
	dh_installmime
	dh_installmodules
	dh_installlogcheck
	dh_installlogrotate
	dh_installpam
	dh_installppp
	dh_installudev
	dh_installwm
	dh_installgsettings

	dh_bugfiles
	dh_ucf
	dh_lintian
	dh_gconf
	dh_icons
	dh_perl
	dh_usrlocal

	dh_link
	dh_installxfonts
	dh_compress
	dh_fixperms
#	dh_strip
	dh_makeshlibs
	dh_shlibdeps  --sysroot=$(ROOTFSDIR)
	dh_installdeb

	echo "kversion=$(KVERSION)" >>$(DEBIAN_DIR)/linux-modules.substvars
	dh_gencontrol -plinux-modules -- -DPackage=linux-modules-$(KVERSION)
	mv $(DEBIAN_DIR)/linux-modules/usr/share/doc/linux-modules \
		$(DEBIAN_DIR)/linux-modules/usr/share/doc/linux-modules-$(KVERSION)

	dh_md5sums
	dh_builddeb

binary-indep:

clean: clean-changelog
	dh_testdir
	dh_clean

#
# changelog
#

VERSION := $(shell git describe --tags --dirty | sed -e 's/^axiom-v//'  -e 's/-/+/' -e 's/-/~/g')
BDATE := $(shell date -R)

define changelog
linux-modules ($(VERSION)) unstable; urgency=low

  * Dummy changelog.

 -- Foo <foo@bar.com>  $(BDATE)
endef
export changelog

.PHONY: make-changelog clean-changelog

make-changelog:
	echo "$$changelog" >$(DEBIAN_DIR)/changelog

clean-changelog:
	rm -f $(DEBIAN_DIR)/changelog
